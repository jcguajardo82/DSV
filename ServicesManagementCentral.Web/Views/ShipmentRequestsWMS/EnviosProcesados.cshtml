@model IEnumerable<ServicesManagement.Web.Models.ShipmentPackingModel>

@{

    Layout = "~/Views/Shared/_Layout.cshtml";

    ViewBag.Title = "Ordenes Procesados";
}
<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-lg-10">
        <h2>@ViewBag.Title </h2>
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="~/CPanel/Index">Home</a>
            </li>
            <li class="breadcrumb-item">
                <a>WMS Cedis</a>
            </li>
            <li class="breadcrumb-item active">
                <strong>Ordenes Procesados</strong>
            </li>
        </ol>
    </div>
</div>
<div id="tblConsulta_wrapper" class="dataTables_wrapper dt-bootstrap4 no-footer">
    <div class="row">
        <div class="col col-xs-6">
            @*<div class="dt-buttons btn-group flex-wrap">
                    <button class="btn btn-secondary buttons-copy buttons-html5" tabindex="0" aria-controls="tblConsulta" type="button"><span>Copy</span></button>
                    <button class="btn btn-secondary buttons-csv buttons-html5" tabindex="0" aria-controls="tblConsulta" type="button"><span>CSV</span></button>
                    <button class="btn btn-secondary buttons-excel buttons-html5" tabindex="0" aria-controls="tblConsulta" type="button"><span>Excel</span></button>
                </div>*@
        </div>

        <div id="topRightSection" class="col-xs-12 col-md-6 text-right ">

            <button type="button" class="btn btn-primary" onclick="SolicitudGuia()">
                @*data-toggle="modal" data-target="#dlgCreateServicios">*@
                Solicitar Guia
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-sm-12">
            <table id="tblConsulta" class="display table table-striped table-bordered table-hover table-responsive-md expand dataTable no-footer" role="grid" style="width: 1115px;">
                <thead class="bg-primary">
                    <tr role="row">
                        @*<th class="text-center sorting" tabindex="0" aria-controls="tblConsulta" rowspan="1">Referencia</th>*@
                        <th class="sorting" tabindex="0" aria-controls="tblConsulta" rowspan="1" colspan="1">Fecha de Creación de Consignación</th>
                        <th class="sorting" tabindex="0" aria-controls="tblConsulta" rowspan="1" colspan="1">Cuenta</th>
                        <th class="sorting" tabindex="0" aria-controls="tblConsulta" rowspan="1" colspan="1">Cantidad</th>
                        <th class="text-center sorting" tabindex="0" aria-controls="tblConsulta" rowspan="1">Referencia 2</th>
                        <th class="sorting" tabindex="0" aria-controls="tblConsulta" rowspan="1" colspan="1">Cliente</th>
                        <th class="sorting" tabindex="0" aria-controls="tblConsulta" rowspan="1" colspan="1">Dirección 1</th>

                        @*<th class="text-center sorting" tabindex="0" aria-controls="tblConsulta" rowspan="1">Dirección 2</th>*@
                        <th class="sorting" tabindex="0" aria-controls="tblConsulta" rowspan="1" colspan="1">Colonia</th>
                        <th class="sorting" tabindex="0" aria-controls="tblConsulta" rowspan="1" colspan="1">Población</th>
                        <th class="text-center sorting" tabindex="0" aria-controls="tblConsulta" rowspan="1">Codigo Postal</th>
                        <th class="sorting" tabindex="0" aria-controls="tblConsulta" rowspan="1" colspan="1">Telefono</th>
                        <th class="sorting" tabindex="0" aria-controls="tblConsulta" rowspan="1" colspan="1">Contacto</th>
                        <th class="sorting" tabindex="0" aria-controls="tblConsulta" rowspan="1" colspan="1">PK</th>
                        <th class="sorting" tabindex="0" aria-controls="tblConsulta" rowspan="1" colspan="1">Guía de Rastreo (paquetería)</th>
                        <th class="sorting" tabindex="0" aria-controls="tblConsulta" rowspan="1" colspan="1">Paquetería</th>
                        <th style="width: 50px;"></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

        </div>

    </div>

</div>

@Html.Partial("SolicitarGuia")

@section scripts {
    <script type="text/javascript">
        var _json = undefined;
        $(document).ready(function () {
            Get();
        });

        function ShowFilter() {
            $("#filter").collapse('toggle');
        };

        function Get() {

            $.ajax({
                async: false,
                type: "GET",
                url: '@Url.Action("GetShipmentProcessedFromWMS", "ShipmentRequestsWMS")',
                data: {
                    //  Id_Num_UN: _Id_Num_UN
                },
                datatype: "html",
                success: function (json) {
                    if (json.Success) {
                        $("#tblConsulta tbody").remove();
                        //var tr;
                        console.log(json);
                        //Append each row to html table
                        for (var i = 0; i < json.json.length; i++) {
                            tr = $('<tr/>');
                            //tr.append("<td class='row1'>" + json.json[i].Id_Num_Orden + "</td>");
                            tr.append("<td></td>");
                            tr.append("<td>" + json.json[i].Cuenta + "</td>");
                            tr.append("<td>" + json.json[i].cantidad + "</td>");
                            tr.append("<td>" + json.json[i].referencia2 + "</td>");
                            tr.append("<td>" + json.json[i].siglasCliente + "</td>");
                            tr.append("<td>" + json.json[i].direccion + "</td>");
                            tr.append("<td>" + json.json[i].colonia + "</td>");
                            tr.append("<td>" + json.json[i].poblacion + "</td>");

                            tr.append("<td>" + json.json[i].codigoPostal + "</td>");
                            tr.append("<td>" + json.json[i].telefono + "</td>");
                            tr.append("<td>" + json.json[i].contacto + "</td>");
                            tr.append("<td>" + json.json[i].ucc + "</td>");
                            tr.append("<td></td>");
                            tr.append("<td></td>");

                            //tr.append("<td><button type = 'button' class= 'btn btn-white btn-circle'> <i class='fa fa-edit'></i></button><button type='button' class='btn btn-warning btn-circle'> <i class='fa fa-minus'></i></button></td >")
                            tr.append("<td><input class='form - check - input' type='checkbox' value='" + json.json[i].idShipmentWMS + "' id='chkSel_" + json.json[i].idShipmentWMS + "' /> </td >")
                            @*<input class="form-check-input" type="checkbox" value="" id="chkSel_@p["Barcode"].ToString()" />
                            tr.append("<td><button onclick='Edit(" + json.json[i].idCnscPacking + ")' type = 'button' class= 'btn btn-white btn-circle'> <i class='fa fa-edit'></i></button><button type='button'  onclick='Delete(" + json.json[i].idCnscPacking + ")'  class='btn btn-warning btn-circle'> <i class='fa fa-minus'></i></button></td >")*@
                            $('#tblConsulta').append(tr);

                        }
                    }
                }
                , error: function (jqXHR, textStatus, errorThrown) {
                    bootbox.alert(errorThrown);
                }
            });
        }

        $('#dlgCreateServicios').on('show.bs.modal', function (e) {
            //LimpiaModal();
            //Disabled();
        });

        function SolicitudGuia() {
            var selProd = 0;
            _json = [];

            $('input[type=checkbox][id*=chkSel_]').each(function () {
                if ($(this).is(":checked") && $(this).is(":disabled") == false) {
                    selProd++
                    row = $(this).closest("tr");
                    let _obj = {};
                    _obj.idShip = $(this).val();
                    _obj.cuenta = $(row)[0].cells[0].innerText;
                    _obj.referencia = $(row)[0].cells[2].innerText;
                    _obj.pk = $(row)[0].cells[10].innerText;
                    _obj.tipoEmpaque = '';
                    _obj.porcentaje = 0;
                    _obj.ancho = 0;
                    _obj.largo = 0;
                    _obj.alto = 0;
                    _obj.peso = 0;
                    //alert($(row)[0].cells[2].innerText);
                    _json.push(_obj);
                }
            });
            //alert(selProd);

            if (selProd > 0) {
                $('#dlgCreateServicios').modal('show');
                console.log(_json);

                $("#tblSolicitud tbody").remove();
                $("#tblSolicitud tr").remove();
                trTh = $('<tr/>');
                trTh.append("<th class='sorting' tabindex='0' aria-controls='tblConsulta' rowspan='1' width='100px' colspan='1'>Referencia</th>");
                trTh.append("<th class='sorting' tabindex='0' aria-controls='tblConsulta' rowspan='1' width='100px' colspan='1'>PK</th>");
                trTh.append("<th class='sorting' tabindex='0' aria-controls='tblConsulta' width='100px' rowspan='1'>Tipo de Empaque</th>");
                trTh.append("<th class='sorting' tabindex='0' aria-controls='tblConsulta' width='60px' rowspan='1' colspan='1'>Porcentaje</th>");
                trTh.append("<th class='sorting' tabindex='0' aria-controls='tblConsulta' width='50px' rowspan='1' colspan='1'>Ancho</th>");
                trTh.append("<th class='sorting' tabindex='0' aria-controls='tblConsulta' rowspan='1' colspan='1'>Largo</th>");
                trTh.append("<th class='sorting' tabindex='0' aria-controls='tblConsulta' rowspan='1' colspan='1'>Alto</th>");
                trTh.append("<th class='sorting' tabindex='0' aria-controls='tblConsulta' rowspan='1' colspan='1'>Peso</th>");
                $('#tblSolicitud').append(trTh);
                //var tr;
                //console.log(json);
                //Append each row to html table
                for (var i = 0; i < _json.length; i++) {
                    tr = $('<tr/>');
                    //tr.append("<td class='row1'>" + json.json[i].Id_Num_Orden + "</td>");
                    tr.append("<td>" + _json[i].referencia + "</td>");
                    tr.append("<td>" + _json[i].pk + "</td>");
                    tr.append("<td> <select class='form-control m-b' onchange='Rebind(" + _json[i].idShip + "," + _json[i].cuenta + "," + i + ")' id='ddlCodigo_" + i +"'> "
                        + "  <option value = 'CJA'> CJA</option><option value='STC'>STC</option><option value='SBR'>SBR</option><option value='EMB'>EMB</option></select > </td>");
                    tr.append("<td><input type='text' readonly id='porcentaje" + i + "' value='" + _json[i].porcentaje + "' name='porcentaje' class='form - control' style='width: 40px' /></td>");
                    tr.append("<td><input type='text' readonly id='ancho" + i + "' value='" + _json[i].ancho + "' name='ancho' class='form - control' style='width: 60px' /></td>");
                    tr.append("<td><input type='text' readonly id='largo" + i+ "' value='" + _json[i].largo + "' name='largo' class='form - control' style='width: 60px' /></td>");
                    tr.append("<td><input type='text' readonly id='alto" + i + "' value='" + _json[i].alto + "' name='alto' class='form - control' style='width: 60px'/></td>");
                    tr.append("<td><input type='text' readonly id='peso" + i + "' value='" + _json[i].peso + "' name='peso' class='form - control' style='width: 60px' /></td>");
                    $('#tblSolicitud').append(tr);

                    $("#ddlCodigo_" + i).val('');
                }
            }
        }

        function Rebind(idShip, cuenta, index) {
            var selectVal = $("#ddlCodigo_" + index).val();
            //console.log('entra', idShip, cuenta, index, selectVal);
            var jsonCopy = _json;
            _json = [];
            $.ajax({
                async: false,
                type: "GET",
                url: '@Url.Action("GetShipmentPackingWMSByCode", "ShipmentRequestsWMS")',
                data: {
                    code: selectVal
                },
                datatype: "html",
                success: function (json) {
                    if (json.Success) {
                        for (var x = 0; x < jsonCopy.length; x++) {
                            let _obj = {};
                            _obj.idShip = jsonCopy[x].idShip;
                            _obj.cuenta = jsonCopy[x].cuenta;
                            _obj.referencia = jsonCopy[x].referencia;
                            _obj.pk = jsonCopy[x].pk;
                            
                            _obj.porcentaje = 0;
                            if (jsonCopy[x].idShip == idShip && jsonCopy[x].cuenta == cuenta) {
                                _obj.tipoEmpaque = selectVal;
                                _obj.ancho = json.json[0].PackageWidth;
                                _obj.largo = json.json[0].PackageLength;
                                _obj.alto = json.json[0].PackageHeight;
                                _obj.peso = json.json[0].PackageWeight;
                            }
                            else {
                                _obj.tipoEmpaque = jsonCopy[x].tipoEmpaque;
                                _obj.ancho = jsonCopy[x].ancho;
                                _obj.largo = jsonCopy[x].largo;
                                _obj.alto = jsonCopy[x].alto;
                                _obj.peso = jsonCopy[x].peso;
                            }
                            //alert('Insert');
                            _json.push(_obj);
                        }


                        $("#tblSolicitud tbody").remove();
                        $("#tblSolicitud tr").remove();
                        trTh = $('<tr/>');
                        trTh.append("<th class='sorting' tabindex='0' aria-controls='tblConsulta' rowspan='1' width='100px' colspan='1'>Referencia</th>");
                        trTh.append("<th class='sorting' tabindex='0' aria-controls='tblConsulta' rowspan='1' width='100px' colspan='1'>PK</th>");
                        trTh.append("<th class='sorting' tabindex='0' aria-controls='tblConsulta' width='100px' rowspan='1'>Tipo de Empaque</th>");
                        trTh.append("<th class='sorting' tabindex='0' aria-controls='tblConsulta' width='60px' rowspan='1' colspan='1'>Porcentaje</th>");
                        trTh.append("<th class='sorting' tabindex='0' aria-controls='tblConsulta' width='50px' rowspan='1' colspan='1'>Ancho</th>");
                        trTh.append("<th class='sorting' tabindex='0' aria-controls='tblConsulta' rowspan='1' colspan='1'>Largo</th>");
                        trTh.append("<th class='sorting' tabindex='0' aria-controls='tblConsulta' rowspan='1' colspan='1'>Alto</th>");
                        trTh.append("<th class='sorting' tabindex='0' aria-controls='tblConsulta' rowspan='1' colspan='1'>Peso</th>");
                        $('#tblSolicitud').append(trTh);
                        //var tr;
                        //console.log(json);
                        //Append each row to html table
                        for (var i = 0; i < _json.length; i++) {
                            tr = $('<tr/>');
                            //tr.append("<td class='row1'>" + json.json[i].Id_Num_Orden + "</td>");
                            tr.append("<td>" + _json[i].referencia + "</td>");
                            tr.append("<td>" + _json[i].pk + "</td>");
                            tr.append("<td> <select class='form-control m-b' onchange='Rebind(" + _json[i].idShip + "," + _json[i].cuenta + "," + i + ")' id='ddlCodigo_" + i + "'> "
                                + "  <option value = 'CJA'> CJA</option><option value='STC'>STC</option><option value='SBR'>SBR</option><option value='EMB'>EMB</option></select > </td>");
                            if (_json[i].tipoEmpaque == 'EMB') {
                                tr.append("<td><input type='text' id='porcentaje" + i + "' value='" + _json[i].porcentaje + "' name='porcentaje' class='form - control' style='width: 40px' /></td>");
                                tr.append("<td><input type='text' id='ancho" + i + "' value='" + _json[i].ancho + "' name='ancho' class='form - control' style='width: 60px' /></td>");
                                tr.append("<td><input type='text' id='largo" + i + "' value='" + _json[i].largo + "' name='largo' class='form - control' style='width: 60px' /></td>");
                            }
                            else {
                                tr.append("<td><input type='text' readonly id='porcentaje" + i + "' value='" + _json[i].porcentaje + "' name='porcentaje' class='form - control' style='width: 40px' /></td>");
                                tr.append("<td><input type='text' readonly id='ancho" + i + "' value='" + _json[i].ancho + "' name='ancho' class='form - control' style='width: 60px' /></td>");
                                tr.append("<td><input type='text' readonly id='largo" + i + "' value='" + _json[i].largo + "' name='largo' class='form - control' style='width: 60px' /></td>");
                            }
                            if (_json[i].tipoEmpaque == 'EMB' || _json[i].tipoEmpaque == 'STC') {
                                tr.append("<td><input type='text' id='alto" + i + "' value='" + _json[i].alto + "' name='alto' class='form - control' style='width: 60px'/></td>");
                                tr.append("<td><input type='text' id='peso" + i + "' value='" + _json[i].peso + "' name='peso' class='form - control' style='width: 60px' /></td>");
                            }
                            else {
                                tr.append("<td><input readonly type='text' id='alto" + i + "' value='" + _json[i].alto + "' name='alto' class='form - control' style='width: 60px'/></td>");
                                tr.append("<td><input readonly type='text' id='peso" + i + "' value='" + _json[i].peso + "' name='peso' class='form - control' style='width: 60px' /></td>");
                            }
                            $('#tblSolicitud').append(tr);

                            //if (i == index)
                            //    $("#ddlCodigo_" + index).val(selectVal);
                            $("#ddlCodigo_" + i).val(_json[i].tipoEmpaque);
                        }

                        
                    }
                }
                , error: function (jqXHR, textStatus, errorThrown) {
                    bootbox.alert(errorThrown);
                }
            });

            //$("#ddlCodigo_" + index).val(selectVal);
       }

        function LimpiaModal() {
            $("#ddlCodigo").val('');
            $("#tipoEmpaque").val('');
            $("#largo").val('');
            $("#ancho").val('');
            $("#alto").val('');
            $("#peso").val('');

            $("#ddlEstatus").val("1");
            $("#idCnscPacking").val(0);
        }
    </script>

}
