@using ServicesManagement.Web.Models.NivelExistencia
@{
    ViewBag.Title = "Nivel de Existencia";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row">
    <div class="col col-xs-12 col col-md-12 col col-lg-12 text-center" ">
        <h2>Niveles de Existencia</h2>
    </div>
</div>
<div class="row">
    <div class="col-sm-2 col-md-2 col-lg-2">
        <div class="form-group">
            <label>Fecha Inicio</label>
            @*<input type="date" id="txtFecIniTarifa" class="form-control" />*@
            <div class="input-group date" id="datetimepicker1">
                <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                <input class="form-control datepicker" id="txtFecIni"
                       type="text" value="@ViewBag.FecIni">
            </div>
        </div>
    </div>
    <div class="col-sm-2 col-md-3 col-lg-2">
        <label>Fecha Fin</label>
        @*<input type="date" id="txtFecIniTarifa" class="form-control" />*@
        <div class="input-group date" id="datetimepicker2">
            <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
            <input class="form-control datepicker" id="txtFecFin"
                   type="text" value="@ViewBag.FecFin">
        </div>
    </div>
    <div class="col-sm-2 col-md-3 col-lg-2">
        <div class="form-group">
            <label>Almacen </label>
            <select class="form-control m-b" id="ddlAlmacenes">
                <option value="0">--SELECCIONE--</option>
            </select>
        </div>
    </div>
    <div class="col-sm-2 col-md-3 col-lg-2">
        <div class="form-group">
            <label>Tienda/Proveedor</label>
            <select class="form-control m-b" id="ddlTienda">
                <option value="0">--SELECCIONE--</option>
            </select>
        </div>
    </div>
    <div class="col-sm-2 col-md-2 col-lg-2" style="vertical-align:bottom;">
        <label>&nbsp;</label>
        <button class="btn btn-lg btn-block btn-primary mt-auto" type="submit" onclick="Busqueda()">
            Buscar
        </button>

    </div>
</div>
<div class="row">
    <div class="col-sm-12 col-md-12 col-lg-12">
        <table id="tblConsulta" class="table table-striped table-bordered table-hover table-responsive-md expand dataTable no-footer">
            <thead class="bg-danger-sor">
                <tr>
                    <th>EAN/Codigo de barras</th>
                    <th>ID (#numero material SAP)</th>
                    <th>Nombre del Producto</th>
                    <th>Grupo de Categorías</th>
                    <th>No. Proveedor</th>
                    <th>T. Almacen</th>
                    <th>Nombre Proveedor</th>
                    <th>Nombre Almacen</th>
                    <th>Nivel de Existencias</th>
                    <th>Inventario Reservado</th>
                    <th>Inventario disponible para la venta</th>
                    <th>Stock de seguridad</th>
                    <th>Tipo de Articulo</th>
                    <th>Largo</th>
                    <th>Alto</th>
                    <th>Ancho</th>
                    <th>Peso</th>
                    <th>Peso Volumetrico</th>
                    <th>Peso Real</th>
                    <th>Estatus del codigo</th>
                    <th>Costo del Material</th>
                    <th>Fecha de cracion del Material</th>
                    <th>Num de proveedor que surte producto</th>
                    <th>Nom de proveedor que surte producto</th>
                </tr>
            </thead>
            <tbody>
                @{

                    IEnumerable<upCorpOMS_Cns_UeNoTotalsByOrder> list = ViewBag.Orders as IEnumerable<upCorpOMS_Cns_UeNoTotalsByOrder>;
                }
                @foreach (upCorpOMS_Cns_UeNoTotalsByOrder item in list)
                {
                    <tr>

                        <td style="text-align:left;">@item.EAN</td>

                        <td style="text-align:left;">@item.SKU</td>
                        <td style="text-align:left;">@item.Descripcion</td>
                        <td style="text-align:left;">@item.Categoria</td>
                        <td style="text-align:left;">@item.NroProveedor</td>
                        <td style="text-align:left;">@item.TipoAlmacen</td>
                        <td style="text-align:left;">@item.NombreProveedor</td>
                        <td style="text-align:left;">@item.NombreAlmacen</td>

                        <td style="text-align:left;">@item.NivelExistencia</td>
                        <td style="text-align:left;">@item.InvReservado</td>
                        <td style="text-align:left;">@item.InvVenta</td>
                        <td style="text-align:left;">@item.InvSeguridad</td>
                        <td style="text-align:left;">@item.TipoArticulo</td>
                        <td style="text-align:left;">@item.Largo</td>
                        <td style="text-align:left;">@item.Alto</td>
                        <td style="text-align:left;">@item.Ancho</td>
                        <td style="text-align:left;">@item.Peso</td>
                        <td style="text-align:left;">@item.PesoVol</td>
                        <td style="text-align:left;">@item.PesoReal</td>
                        <td style="text-align:left;">@item.EstatusProducto</td>
                        <td style="text-align:left;">@item.CostoMaterial</td>
                        <td style="text-align:left;">@item.FechaCreacion</td>

                        <td style="text-align:left;">@item.NroProvOrigen</td>
                        <td style="text-align:left;">@item.NomProvOrigen</td>

                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section scripts {
    @*CONFIGURACION DE TABLAS, FILTROS, BOTONES DE EXPORT*@
<script>

        $(function () {
            $('#datetimepicker1').datetimepicker({
                locale: 'es'
                , format: "yyyy/MM/DD"
            });
            $('#datetimepicker2').datetimepicker({
                locale: 'es'
                , format: "yyyy/MM/DD"
            });

        });


        function ListAlmacen() {
             $.ajax({
                async: false,
                type: "GET",
                url: '@Url.Action("ListAlmacen", "Config")',
                data: {

                },
                datatype: "html",
                success: function (json) {
                    debugger;
                    if (json.Success) {
                        var sel = $("#ddlAlmacenes");
                        sel.empty();

                        $('#ddlAlmacenes').get(0).options[0] = new Option("--SELECCIONE--", "0");
                        for (var i = 0; i < json.resp.length; i++) {
                            sel.append('<option value="' + json.resp[i].IdOwner + '">' + json.resp[i].OwnerName +'</option>');
                        }

                        $("#ddlAlmacenes").val("@ViewBag.IdOwner");
                        GetSupp(@ViewBag.IdOwner);

                    }
                    else {
                        alert(json.Message);
                    }
                }
                , error: function (jqXHR, textStatus, errorThrown) {
                    bootbox.alert(errorThrown);

                }
            });
        }

        $("#ddlAlmacenes").change(function () {

            GetSupp($("#ddlAlmacenes").val());

        });

            function GetSupp(_idOwner) {
            $.ajax({
                async: false,
                type: "GET",
                url: '@Url.Action("ListSuppliersById", "Config")',
                data: {
                    idOwner: _idOwner
                },
                datatype: "html",
                success: function (json) {
                    debugger;
                    if (json.Success) {
                        var sel = $("#ddlTienda");
                        sel.empty();

                        $('#ddlTienda').get(0).options[0] = new Option("--SELECCIONE--", "0");
                        for (var i = 0; i < json.resp.length; i++) {
                            sel.append('<option value="' + json.resp[i].IdProveedor + '">' + json.resp[i].NombreProveedor + '</option>');
                        }



                        if ($("#ddlTienda option[value='@ViewBag.IdTienda']").length == 0) {
                            $("#ddlTienda").val("0");
                        } else {  $("#ddlTienda").val("@ViewBag.IdTienda");}
                    }
                    else {
                        alert(json.Message);
                    }
                }
                , error: function (jqXHR, textStatus, errorThrown) {
                    bootbox.alert(errorThrown);

                }
            });
        }

        $(document).ready(function () {
            $('#tblConsulta thead tr').clone(true).appendTo('#tblConsulta thead');
            $('#tblConsulta thead tr:eq(0) th').each(function (i) {
                if ($(this).attr('name') != "accion") {
                    var title = $(this).text();
                    $(this).html('<input type="text" class="form form-control input-sm" placeholder="' + title + '" />');

                    $('input', this).on('keyup change', function () {
                        if (table.column(i).search() !== this.value) {
                            table
                                .column(i)
                                .search(this.value)
                                .draw();
                        }
                    });
                } else {
                    $(this).empty();
                }
            });

            table = $("#tblConsulta").DataTable(
                {
                    dom: "<'row'<'col col-xs-6'B><'#topRightSection.col-xs-12 col-md-6 text-right' f>>" +
                        "<'row'<'col-sm-12'tr>>" +
                        "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'lp>>",
                    processing: true,
                    searching: true,
                    ordering: true,
                    order: [[1, 'asc']],
                    filter: true,
                    info: false,
                    stateSave: false,
                    select: false,
                    select: {
                        style: 'single'
                    },
                    //Paggin

                    paging: true,
                    pageLength: 10,
                    lengthMenu: [10, 25, 50, 100, 500],

                    // destroy: true, //destruye automaticamente la referencia a la tabla
                    //Ajax
                    //serverSide: true,
                    //bServerSide: true,
                    //sServerMethod: "GET",
                    buttons: ['csv', 'excel'],
                    orderCellsTop: false,
                    fixedHeader: {
                        header: true,
                        footer: true
                    },
                    "scrollX": true
                    , "scrollY": "400px"
                    , "scrollCollapse": true
                }
            );


            ListAlmacen();
        });

    function Busqueda() {
        var _FecIni = $("#txtFecIni").val();
        var _FecFin = $("#txtFecFin").val();
        var _IdOwner = $("#ddlAlmacenes").val();
        var _IdTienda = $("#ddlTienda").val();

        if (_FecIni.length == 0) {
            $("#txtFecIni").focus();
            return;
        }


        if (_FecFin.length == 0) {
            $("#txtFecFin").focus();
            return;
        }

        window.location.href = "NivelExistencia/NivelExistencia?FecIni=" + _FecIni + "&FecFin="+ _FecFin + "&IdOwner=" + _IdOwner + "&IdTienda=" + _IdTienda;
    }
</script>
}

